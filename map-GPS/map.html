<!DOCTYPE html>
<html>
<head>
    <title>Hiking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        /* this sets up the map size so it fills most of the screen */
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body>
    <h1>My Hiking Map</h1>
     <!-- buttons for the different GPS and hike actions -->
    <div style="margin:12px 0;">
      <button id="btnLogin">Login (use test_user)</button>
      <button id="btnStartHike">Start Hike</button>
      <button id="btnStartTrack">Start GPS Track</button>
      <button id="btnStopTrack">Stop Track</button>
      <button id="btnCompleteHike">Complete Hike</button>
      <span id="status" style="margin-left:12px;"></span>
    </div>
    <div id="map"></div>
    <!-- pulls in the leaflet map library -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        // tries to find the user's location and center the map on them
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            map.setView([lat, lon], 13);
            L.marker([lat, lon]).addTo(map).bindPopup("You are here!").openPopup();
          });
        } else {
          alert("Geolocation is not supported by this browser.");
        }
        // setup for talking to the backend
        const API = '/api';
        let token = localStorage.getItem('token') || '';
        let hikeId = null;
        let trackId = null;
        let watchId = null;
        const setStatus = (msg) => document.getElementById('status').textContent = msg;

        // helper function to call the backend with fetch
        async function api(path, method='GET', body=null) {
          const headers = { 'Content-Type': 'application/json' };
          if (token) headers['Authorization'] = 'Token ' + token;
          const res = await fetch(`${API}${path}`, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(`HTTP ${res.status}: ${t}`);
          }
          const text = await res.text();
          return text ? JSON.parse(text) : {};
        }

        // logs in using the test account and saves the token
        document.getElementById('btnLogin').onclick = async () => {
          try {
            const data = await api('/users/login/', 'POST', {
              username: 'test_user',
              password: 'testpassword123'
            });
            token = data.token || data.access || data.key || '';
            localStorage.setItem('token', token);
            setStatus('Logged in. Token saved.');
          } catch (e) { console.error(e); setStatus('Login failed.'); }
        };

        // starts a new hike in the backend
        document.getElementById('btnStartHike').onclick = async () => {
          try {
            const startedAt = new Date().toISOString();
            const data = await api('/hikes/', 'POST', { trail: 123, started_at: startedAt });
            hikeId = data.id;
            setStatus(`Hike started (id=${hikeId}).`);
          } catch (e) { console.error(e); setStatus('Start hike failed.'); }
        };

        // starts tracking GPS points for the current hike
        document.getElementById('btnStartTrack').onclick = async () => {
          if (!hikeId) return setStatus('Start a hike first.');
          try {
            const data = await api('/gps-tracks/', 'POST', { hike: hikeId });
            trackId = data.id;
            setStatus(`Tracking started (track=${trackId}).`);

              // starts watching the user's GPS and sends new points to the backend
            if (!navigator.geolocation) return setStatus('Geolocation not supported.');
            watchId = navigator.geolocation.watchPosition(async (pos) => {
              try {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                await api(`/gps-tracks/${trackId}/add_track_point/`, 'POST', {
                  latitude: lat,
                  longitude: lon
                });
                  // drops a marker on the map each time a point is recorded
                L.marker([lat, lon]).addTo(map).bindPopup('Point recorded');
              } catch (e) { console.error('Add point failed', e); }
            }, (err) => console.warn('watchPosition error', err), {
              enableHighAccuracy: true, maximumAge: 5000, timeout: 20000
            });
          } catch (e) { console.error(e); setStatus('Start track failed.'); }
        };

        // stops the GPS tracking and tells the backend to stop
        document.getElementById('btnStopTrack').onclick = async () => {
          if (!trackId) return setStatus('No active track.');
          try {
            if (watchId !== null) {
              navigator.geolocation.clearWatch(watchId);
              watchId = null;
            }
            await api(`/gps-tracks/${trackId}/stop/`, 'POST');
            setStatus('Tracking stopped.');
          } catch (e) { console.error(e); setStatus('Stop track failed.'); }
        };

        // ends the hike and sends distance/time to backend
        document.getElementById('btnCompleteHike').onclick = async () => {
          if (!hikeId) return setStatus('No active hike.');
          try {
            await api(`/hikes/${hikeId}/complete/`, 'POST', {
              distance_miles: 3.5,
              duration_min: 90
            });
            setStatus('Hike completed.');
          } catch (e) { console.error(e); setStatus('Complete hike failed.'); }
        };
    </script>
</body>
</html>
